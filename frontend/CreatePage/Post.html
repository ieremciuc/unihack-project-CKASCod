<!DOCTYPE html>
<html>
    <head>
        <title> Folkline </title>
        <meta name="viewport" content="width-device-width, initial-scale=1.0">
        <link rel="stylesheet" href="stylecreate.css">
        <link rel="stylesheet" href="../navbar/nav-style.css">
        <link rel="stylesheet" href="../topbar/top-style.css">
    </head>
    <body>
        <div id="topbar"></div>
        <br><br><br><br>

        <div class="square">
            <div class="search">
                <input type="text" id="searchbox" placeholder="Pick a country">
                <div id="list" class="list">
                </div>
            </div>
            <label for="description">Description</label>
            <textarea id="description" placeholder="insert *cute description*"></textarea>
            <div class="buttons">
                <button id="post1"> Post</button>
                <button id="back1">Back</button>
            </div>
        </div>
        <script type="module">
            import { SUPABASE_API_URL } from "../config.js";
            import { CLOUDINARY_API_URL } from "../config.js";

            async function request(endpoint, method = "GET", body = null) {
                const opts = {
                    method,
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`${SUPABASE_API_URL}${endpoint}`, opts);
                try { return await res.json(); }
                catch { return { error: "Invalid JSON response" }; }
            }

            let uploadedFile = null;        
            window.addEventListener('load', async () => {
                const raw = localStorage.getItem('uploadedFile');
                if (!raw) {
                alert('No image selected - go back to the select page');
                window.location.href = 'Select.html';
                return;
                }

                const obj  = JSON.parse(raw);
                const blob = await fetch(obj.dataUrl).then(r => r.blob());
                uploadedFile = new File([blob], obj.name, { type: obj.type });
            });
            
            const countries = [
                "Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda",
                "Argentina","Armenia","Australia","Austria","Azerbaijan",
                "Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin",
                "Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei",
                "Bulgaria","Burkina Faso","Burundi", "Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (Congo-Brazzaville)",
                "Costa Rica","Côte d’Ivoire","Croatia","Cuba","Cyprus","Czech Republic",
                "Democratic Republic of the Congo","Denmark","Djibouti","Dominica",
                "Dominican Republic", "Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini", "Ethiopia", "Fiji","Finland","France",
                "Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala",
                "Guinea","Guinea-Bissau","Guyana", "Haiti","Honduras","Hungary",
                "Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy",
                "Jamaica","Japan","Jordan", "Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan",
                "Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein",
                "Lithuania","Luxembourg", "Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands",
                "Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia",
                "Montenegro","Morocco","Mozambique","Myanmar", "Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger",
                "Nigeria","North Korea","North Macedonia","Norway", "Oman",
                "Pakistan","Palau","Panama","Papua New Guinea","Paraguay","Peru","Philippines",
                "Poland","Portugal","Qatar", "Romania","Russia","Rwanda",
                "Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines",
                "Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia",
                "Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands",
                "Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan",
                "Suriname","Sweden","Switzerland","Syria",
                "Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga",
                "Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu",
                "Uganda","Ukraine","United Arab Emirates","United Kingdom",
                "United States","Uruguay","Uzbekistan",
                "Vanuatu","Vatican City","Venezuela","Vietnam",
                "Yemen","Zambia","Zimbabwe"
            ];

            const searchbox = document.getElementById("searchbox");
            const dropdownList = document.getElementById("list");

            function showList(items)
            {
                dropdownList.innerHTML = "";
                items.forEach(country => {
                    const div = document.createElement("div");
                    div.classList.add("dropdown-item");
                    div.textContent = country;

                    div.onclick = () => {
                        searchbox.value = country;
                        dropdownList.style.display = "none";
                    };

                    dropdownList.appendChild(div);
                });
                dropdownList.style.display = "block";
            }

            searchbox.addEventListener("input", () =>{
                const value = searchbox.value.toLowerCase();
                const filtered = countries.filter(country => country.toLowerCase().includes(value)
                );

                if(filtered.length > 0)
                {
                    showList(filtered);
                } else
                {
                    dropdownList.style.display = "none";
                }
            });

            searchbox.addEventListener("focus", () => showList(countries));

            document.getElementById("back1").addEventListener("click", () => {
                window.location.href = "Select.html";
            });

            document.getElementById('post1').addEventListener('click', async () => {
                const country_name= document.getElementById('searchbox').value.trim();
                const content     = document.getElementById('description').value.trim();

                if (!content)     return alert('Description is required');
                if (!uploadedFile) return alert('No image - go back and select one');

                const form = new FormData();
                form.append('file', uploadedFile);

                let secure_url;
                try {
                const up = await fetch(`${CLOUDINARY_API_URL}/upload`, {
                    method: 'POST',
                    body: form
                });
                const data = await up.json();
                if (data.error) throw new Error(data.error.message);
                    secure_url = data.secure_url;
                } catch (e) {
                    alert('Image upload failed: ' + e.message);
                    return;
                }

                const payload = {
                    country_name: country_name || null,
                    content,
                    image: secure_url,                         
                    is_event: false
                };

                const result = await request('/posts', 'POST', payload);

                if (result.error) {
                    alert('Post failed: ' + (result.error.message || result.error));
                } else {
                    alert('Post posted successfully!');
                    localStorage.removeItem('uploadedFile');
                    window.location.href = '../profile/profile.html';
                }
            });
        </script>

        <br><br><br><br>
        <div id="navbar"></div>

        <script>
            const pageBase = "../../"
            const fetchLocation = pageBase + "frontend/navbar/navbar.html"
            fetch(fetchLocation)
            .then(res => res.text())
            .then(html => {
                html = html.replaceAll("{{BASE}}", pageBase);
                document.getElementById("navbar").innerHTML = html;
                navbar.innerHTML = html;
                const active = navbar.dataset.active;
                const icon = navbar.querySelector(`[data-icon="${active}"]`);
                if (icon) icon.classList.add("active");
            });
            const fetchLocationTop = pageBase + "frontend/topbar/topbar.html"
            fetch(fetchLocationTop)
            .then(res => res.text())
            .then(html => {
                html = html.replaceAll("{{BASE}}", pageBase);
                document.getElementById("topbar").innerHTML = html;
            });
        </script>
    </body>
</html>